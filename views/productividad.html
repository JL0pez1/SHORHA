<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Productividad y Horas Extra - SORHA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/productividad.css">
    <style>
        /* Estilos básicos para alertas si no están en productividad.css */
        .alert { padding: 15px; margin-bottom: 20px; border-radius: 5px; display: none; opacity: 0; transition: opacity 0.5s ease-in-out; font-size: 14px; border-width: 1px; border-style: solid; }
        .alert:not(.hidden) { display: flex; align-items: center; opacity: 1; }
        .alert i { margin-right: 10px; font-size: 1.2em; }
        .alert-success { background-color: #d1e7dd; color: #0f5132; border-color: #badbcc;}
        .alert-error   { background-color: #f8d7da; color: #842029; border-color: #f5c2c7;}
        .alert-info    { background-color: #cff4fc; color: #055160; border-color: #b6effb;}
        .hidden { display: none !important; }

        .consultar-section .form-group { margin-bottom: 0; display: flex; align-items: flex-end; gap: 10px; }
        .consultar-section .form-group input[type="number"] { flex-grow: 1; margin-bottom: 0; }
        #historialTabla, #metricasFormularioContainer { margin-top: 25px; }
        #tablaHistorial tbody tr td[colspan="4"] { text-align: center; font-style: italic; color: #777; }
        #mensajeArea .alert { margin-top: 15px; }
        .metric-item { margin-bottom: 15px; }
        .metric-item label { display: block; margin-bottom: 5px; font-weight: 500;}
        .metric-item input[type="number"] { width:100%; padding:10px; border:1px solid #ccc; border-radius:4px;}
        .metric-item small { font-size:0.85em; color:#666; display:block; margin-top:3px;}
    </style>
</head>
<body>
    <div class="admin-background"></div>
    <div class="admin-overlay"></div>

    <header class="admin-header">
        <div class="header-content">
            <img src="/images/sorha-logo.png" alt="SORHA Logo" class="logo">
            <div class="header-titles">
                <h1>Gestión de <span>Productividad</span></h1>
                <p>Sistema de Organización de Recursos Humanos y Administración</p>
            </div>
        </div>
        <nav>
             <span id="usernameDisplayProductividad" class="username-display">Cargando...</span>
            <a href="/logout" class="btn-logout">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </a>
        </nav>
    </header>

    <main class="admin-main">
        <div class="container">
            <h1>Registro y Consulta de Productividad</h1>
            <div id="mensajeArea"></div>

            <div class="section">
                <div class="section-header">
                     <h2><i class="fas fa-search"></i> Consultar Productividad de Empleado</h2>
                </div>
                <div class="consultar-section">
                    <div class="form-group">
                        <label for="id_colaborador_consulta">ID del Colaborador:</label>
                        <input type="number" id="id_colaborador_consulta" placeholder="Ingrese el ID">
                        <button id="btnConsultarProductividad" class="btn-primary"><i class="fas fa-arrow-right"></i> Consultar</button>
                    </div>
                </div>

                <div id="historialTabla" class="table-container" style="display: none;">
                    <h3>Historial de Productividad Registrado</h3>
                    <table id="tablaHistorial">
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar-alt"></i> Fecha Registro</th>
                                <th><i class="fas fa-chart-line"></i> Métrica</th>
                                <th><i class="fas fa-calculator"></i> Valor</th>
                                <th><i class="fas fa-balance-scale"></i> Unidad</th>
                            </tr>
                        </thead>
                        <tbody id="tablaHistorialBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="section" id="seccionRegistroProductividad" style="display: none;">
                 <div class="section-header">
                    <h2><i class="fas fa-edit"></i> Registrar Nueva Productividad para <span id="nombreColaboradorRegistro" style="font-weight:normal"></span></h2>
                 </div>
                <p><strong>Colaborador ID:</strong> <span id="colaboradorIdRegistroProductividad"></span></p>
                <form id="registroProductividadForm">
                     <div class="form-group">
                        <label for="fecha_registro_productividad"><i class="fas fa-calendar-day"></i> Fecha de Registro (para todas las métricas y horas extra de este envío):</label>
                        <input type="date" id="fecha_registro_productividad" required>
                     </div>

                    <div id="metricasFormularioContainer">
                        <h3>Métricas a Registrar</h3>
                        <div id="metricasInputsDinamicos">
                            </div>
                    </div>
                    <button type="submit" id="btnCargarProductividadYHoras" class="btn-primary" style="margin-top:20px;"><i class="fas fa-upload"></i> Cargar Productividad y Horas Extra</button>
                </form>
            </div>
        </div>
    </main>

    <script>
        const apiBaseUrl = '/api';

        // --- Selectores del DOM ---
        const idColaboradorConsultaInput = document.getElementById('id_colaborador_consulta');
        const btnConsultarProductividad = document.getElementById('btnConsultarProductividad');
        const historialTablaDiv = document.getElementById('historialTabla');
        const tablaHistorialBody = document.getElementById('tablaHistorial').querySelector('tbody');
        const seccionRegistroProductividadDiv = document.getElementById('seccionRegistroProductividad');
        const colaboradorIdRegistroProductividadSpan = document.getElementById('colaboradorIdRegistroProductividad');
        const nombreColaboradorRegistroSpan = document.getElementById('nombreColaboradorRegistro');
        const fechaRegistroProductividadInput = document.getElementById('fecha_registro_productividad');
        const metricasInputsDinamicosDiv = document.getElementById('metricasInputsDinamicos');
        const registroProductividadForm = document.getElementById('registroProductividadForm');
        const mensajeArea = document.getElementById('mensajeArea');
        const usernameDisplaySpan = document.getElementById('usernameDisplayProductividad');

        let colaboradorActualId = null;
        let nombreColaboradorActual = '';
        let metricasDisponibles = [];
        // ¡¡IMPORTANTE!! Verifica que el ID de tu métrica "Horas Trabajadas" sea realmente 4.
        // Consúltalo en tu tabla `metricas`.
        const ID_METRICA_HORAS_TRABAJADAS_O_EXTRA = 4;

        // --- Funciones ---
        function mostrarMensaje(texto, tipo = 'error') {
            // ... (código de mostrarMensaje sin cambios, ya lo tienes de la respuesta anterior)
            console.log(`[SHOW ALERT - ${tipo.toUpperCase()}]: ${texto}`);
            mensajeArea.innerHTML = `<div class="alert alert-${tipo}"><i class="fas ${tipo === 'exito' ? 'fa-check-circle' : (tipo === 'info' ? 'fa-info-circle' : 'fa-exclamation-triangle')}"></i> ${texto}</div>`;
            const alertElement = mensajeArea.querySelector('.alert');
            if(alertElement) {
                alertElement.classList.remove('hidden');
                alertElement.style.opacity = 1;
                setTimeout(() => {
                    alertElement.style.opacity = '0';
                    setTimeout(() => { mensajeArea.innerHTML = ''; }, 500);
                }, 4500);
            }
        }
        
        async function fetchCurrentUsername() {
            // ... (código de fetchCurrentUsername sin cambios, ya lo tienes)
            console.log("fetchCurrentUsername (Productividad) llamado");
            if (!usernameDisplaySpan) { return; }
            try {
                const response = await fetch('/api/session/user');
                if (!response.ok) {
                    if (response.status === 401) window.location.href = '/?error=Sesion+expirada';
                    throw new Error(`HTTP ${response.status}`);
                }
                const result = await response.json();
                if (result.success && result.user) {
                    usernameDisplaySpan.textContent = `Usuario: ${result.user.usuario} (${result.user.rol})`;
                } else { usernameDisplaySpan.textContent = 'Usuario no identificado'; }
            } catch (error) {
                console.error("Error en fetchCurrentUsername (Productividad):", error);
                usernameDisplaySpan.textContent = 'Error cargando usuario';
            }
        }

        btnConsultarProductividad.addEventListener('click', async () => {
            console.log("btnConsultarProductividad clickeado");
            const idColaborador = idColaboradorConsultaInput.value.trim();
            if (!idColaborador || parseInt(idColaborador) <= 0) {
                mostrarMensaje('Por favor, ingrese un ID de colaborador válido.', 'error');
                return;
            }

            colaboradorActualId = idColaborador;
            nombreColaboradorActual = '';
            if(historialTablaDiv) historialTablaDiv.style.display = 'none';
            if(seccionRegistroProductividadDiv) seccionRegistroProductividadDiv.style.display = 'none';
            if(tablaHistorialBody) tablaHistorialBody.innerHTML = '';
            if(metricasInputsDinamicosDiv) metricasInputsDinamicosDiv.innerHTML = '';
            if(mensajeArea) mensajeArea.innerHTML = '';

            try {
                mostrarMensaje('Consultando datos...', 'info');
                // Obtener nombre del colaborador
                try {
                    const resColab = await fetch(`${apiBaseUrl}/${idColaborador}`);
                    if (resColab.ok) {
                        const dataColab = await resColab.json();
                        if (dataColab.success && dataColab.data) {
                            nombreColaboradorActual = `${dataColab.data.primer_nombre || ''} ${dataColab.data.primer_apellido || ''}`.trim();
                        }
                    } else { console.warn(`No se pudo obtener nombre para colaborador ID ${idColaborador}.`); }
                } catch (e) { console.warn("Error obteniendo nombre del colaborador:", e); }
                
                if(nombreColaboradorRegistroSpan) nombreColaboradorRegistroSpan.textContent = nombreColaboradorActual || `ID ${idColaborador}`;


                const [resHistorial, resMetricas] = await Promise.all([
                    fetch(`/api/productividad/registros/${idColaborador}`),
                    fetch('/api/productividad/metricas')
                ]);

                const dataHistorial = await resHistorial.json();
                if (!resHistorial.ok) {
                    mostrarMensaje(dataHistorial.message || `Error ${resHistorial.status} al obtener historial.`, 'error');
                    return;
                }
                if (tablaHistorialBody && historialTablaDiv) {
                    tablaHistorialBody.innerHTML = '';
                     if (dataHistorial.registros && dataHistorial.registros.length > 0) {
                        dataHistorial.registros.forEach(reg => {
                            const fechaFormateada = reg.fecha_registro ? new Date(reg.fecha_registro + 'T00:00:00Z').toLocaleDateString() : 'N/A';
                            const fila = `<tr><td>${fechaFormateada}</td><td>${reg.nombre_metrica}</td><td>${reg.valor_medido}</td><td>${reg.unidad_medida || ''}</td></tr>`;
                            tablaHistorialBody.innerHTML += fila;
                        });
                    } else {
                         tablaHistorialBody.innerHTML = '<tr><td colspan="4">No hay registros históricos de productividad.</td></tr>';
                    }
                    historialTablaDiv.style.display = 'block';
                }

                const dataMetricas = await resMetricas.json();
                 if (!resMetricas.ok) {
                    mostrarMensaje(dataMetricas.message || `Error ${resMetricas.status} al obtener métricas.`, 'error');
                    return;
                }
                metricasDisponibles = dataMetricas.metricas || [];

                 if (metricasDisponibles.length > 0 && seccionRegistroProductividadDiv && colaboradorIdRegistroProductividadSpan && metricasInputsDinamicosDiv) {
                    colaboradorIdRegistroProductividadSpan.textContent = colaboradorActualId;
                    metricasInputsDinamicosDiv.innerHTML = '';
                    metricasDisponibles.forEach(metrica => {
                        let dataAttributeForHE = '';
                        let placeholderText = "Ingrese valor";
                        let labelText = `${metrica.nombre_metrica} ${metrica.unidad_medida ? '('+metrica.unidad_medida+')' : ''}`;

                        if (metrica.id_metrica === ID_METRICA_HORAS_TRABAJADAS_O_EXTRA) {
                            dataAttributeForHE = 'data-is-extra-hours="true"';
                            placeholderText = "Horas trabajadas/extra";
                            labelText = `${metrica.nombre_metrica} (se registrarán también como Horas Extra)`;
                        }
                        const itemMetrica = `
                            <div class="metric-item">
                                <label for="metrica_prod_${metrica.id_metrica}">${labelText}:</label>
                                <input type="number" step="any" id="metrica_prod_${metrica.id_metrica}" 
                                       data-idmetrica="${metrica.id_metrica}" 
                                       ${dataAttributeForHE} placeholder="${placeholderText}" class="metric-input">
                                ${metrica.descripcion ? '<small>'+metrica.descripcion+'</small>' : ''}
                            </div>`;
                        metricasInputsDinamicosDiv.innerHTML += itemMetrica;
                    });
                    if (fechaRegistroProductividadInput) fechaRegistroProductividadInput.valueAsDate = new Date();
                    seccionRegistroProductividadDiv.style.display = 'block';
                 } else if (metricasDisponibles.length === 0) {
                     mostrarMensaje('No hay métricas definidas en el sistema para registrar productividad.', 'info');
                 }
                 mostrarMensaje('Datos cargados. Listo para registrar productividad.', 'info');

            } catch (error) {
                console.error('Error general en consulta de productividad:', error);
                mostrarMensaje(`Error general al consultar: ${error.message}`, 'error');
                if(historialTablaDiv) historialTablaDiv.style.display = 'none';
                if(seccionRegistroProductividadDiv) seccionRegistroProductividadDiv.style.display = 'none';
            }
        });

        if (registroProductividadForm) {
            registroProductividadForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                console.log("Submit del formulario de productividad y horas extra");

                const fechaRegistro = fechaRegistroProductividadInput.value;
                if (!fechaRegistro) {
                    mostrarMensaje('Por favor, seleccione la fecha de registro.', 'error');
                    return;
                }

                const metricasParaProductividadPayload = [];
                let horasExtraParaGuardar = null;
                
                const inputsMetricas = metricasInputsDinamicosDiv.querySelectorAll('.metric-input');
                inputsMetricas.forEach(input => {
                    const valor = input.value.trim();
                    const idMetrica = parseInt(input.dataset.idmetrica);

                    if (valor !== '' && !isNaN(parseFloat(valor))) {
                        metricasParaProductividadPayload.push({
                            id_metrica: idMetrica,
                            valor_medido: parseFloat(valor)
                        });
                        
                        if (input.dataset.isExtraHours === "true" && parseFloat(valor) > 0) {
                            horasExtraParaGuardar = {
                                id_empleado: colaboradorActualId,
                                fecha: fechaRegistro, // Usar la misma fecha de registro de productividad
                                horas: parseFloat(valor),
                                tipo: 'normal' // Asumir 'normal', o añadir un selector si necesitas más tipos
                            };
                        }
                    }
                });

                let productividadOk = false;
                let horasExtraOk = false;
                let mensajesError = [];

                // 1. Guardar Métricas de Productividad
                if (metricasParaProductividadPayload.length > 0) {
                    const datosRegistroProductividad = {
                        id_colaborador: colaboradorActualId,
                        fecha_registro: fechaRegistro,
                        metricas: metricasParaProductividadPayload
                    };
                    console.log("Enviando datos de productividad:", datosRegistroProductividad);
                    try {
                        mostrarMensaje('Registrando productividad...', 'info');
                        const responseProd = await fetch('/api/productividad/registrar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(datosRegistroProductividad)
                        });
                        const resultadoProd = await responseProd.json();
                        if (responseProd.ok && resultadoProd.success) {
                            mostrarMensaje(`Productividad: ${resultadoProd.message}`, 'exito');
                            productividadOk = true;
                        } else {
                            mensajesError.push(resultadoProd.message || `Error ${responseProd.status} al guardar productividad.`);
                        }
                    } catch (error) {
                        console.error('Error al registrar productividad:', error);
                        mensajesError.push(`Error de conexión al registrar productividad: ${error.message}`);
                    }
                } else {
                    console.log("No se ingresaron valores para métricas de productividad.");
                    // Si solo se ingresaron horas extra (y estas se manejan como una métrica también),
                    // puede que no haya nada más que enviar aquí, o que "Horas Trabajadas" deba tener valor.
                    // Por ahora, si no hay otras métricas, no se envía nada a este endpoint.
                }

                // 2. Guardar Horas Extra (si se detectaron)
                if (horasExtraParaGuardar) {
                    console.log("Enviando datos de Horas Extra:", horasExtraParaGuardar);
                    try {
                        mostrarMensaje('Registrando horas extra...', 'info');
                        const responseHE = await fetch(`${apiBaseUrl}/horasextras`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(horasExtraParaGuardar)
                        });
                        const resultadoHE = await responseHE.json();
                        if (responseHE.ok && resultadoHE.success) {
                            mostrarMensaje(`Horas Extra: ${resultadoHE.message}`, 'exito');
                            horasExtraOk = true;
                        } else {
                            mensajesError.push(resultadoHE.message || `Error ${responseHE.status} al guardar horas extra.`);
                        }
                    } catch (error) {
                        console.error('Error al registrar horas extra:', error);
                        mensajesError.push(`Error de conexión al registrar horas extra: ${error.message}`);
                    }
                }
                
                if (mensajesError.length > 0) {
                    mostrarMensaje('Se produjeron errores: ' + mensajesError.join('; '), 'error');
                }

                // Si al menos una operación tuvo éxito, resetea y recarga
                if (productividadOk || horasExtraOk) {
                     if(registroProductividadForm) registroProductividadForm.reset();
                     // Para asegurar que el usuario vea los mensajes de éxito/error, recargamos después de un momento
                     if(btnConsultarProductividad) setTimeout(() => { btnConsultarProductividad.click(); }, 2000);
                } else if (metricasParaProductividadPayload.length === 0 && !horasExtraParaGuardar) {
                    mostrarMensaje('No se ingresó ningún valor para productividad ni para horas extra.', 'info');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Productividad completamente cargado.");
            fetchCurrentUsername();
            if(historialTablaDiv) historialTablaDiv.style.display = 'none';
            if(seccionRegistroProductividadDiv) seccionRegistroProductividadDiv.style.display = 'none';
        });
    </script>
</body>
</html>